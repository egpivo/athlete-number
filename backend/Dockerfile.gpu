# ===========================
# üìå 1Ô∏è‚É£ Base Image with CUDA
# ===========================
FROM nvidia/cuda:12.1.1-runtime-ubuntu22.04 AS backend

# ===========================
# üìå 2Ô∏è‚É£ Install System Dependencies
# ===========================
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    python3.10 \
    python3-pip \
    python3.10-venv \
    build-essential \
    libgl1 \
    libglib2.0-0 \
    curl \
    git \
    lsof && \
    rm -rf /var/lib/apt/lists/*

# ===========================
# üìå 3Ô∏è‚É£ Install Poetry
# ===========================
ENV POETRY_VERSION=2.0.1
RUN curl -sSL https://install.python-poetry.org | python3 - && \
    echo "export PATH=/root/.local/bin:$PATH" >> /root/.bashrc

# Ensure Poetry is in PATH
ENV PATH="/root/.local/bin:$PATH"

# ===========================
# üìå 4Ô∏è‚É£ Set Working Directory
# ===========================
WORKDIR /app

# ===========================
# üìå 5Ô∏è‚É£ Copy Dependencies & Install
# ===========================
COPY pyproject.toml poetry.lock* /app/

# Install dependencies using Poetry (without creating a virtual environment)
RUN poetry config virtualenvs.create false && \
    poetry install --no-interaction --no-ansi --no-root

# ===========================
# üìå 6Ô∏è‚É£ Pre-download Hugging Face Model
# ===========================
RUN mkdir -p /app/models/huggingface && \
    python3 -c "from transformers import AutoModelForImageTextToText, AutoProcessor; \
                model_name = 'stepfun-ai/GOT-OCR-2.0-hf'; \
                AutoModelForImageTextToText.from_pretrained(model_name, cache_dir='/app/models/huggingface'); \
                AutoProcessor.from_pretrained(model_name, cache_dir='/app/models/huggingface')"

# ===========================
# üìå 7Ô∏è‚É£ Copy Application Source Code
# ===========================
COPY . /app/

# ===========================
# üìå 8Ô∏è‚É£ Set Environment Variables for GPU Support
# ===========================
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=compute,utility

# ===========================
# üìå 9Ô∏è‚É£ Expose API Port
# ===========================
EXPOSE 5566

# ===========================
# üìå üî• 1Ô∏è‚É£0Ô∏è‚É£ Start the Application with Gunicorn + Uvicorn
# ===========================
CMD ["gunicorn", "-w", "1", "-k", "uvicorn.workers.UvicornWorker", "--timeout", "600", "--bind", "0.0.0.0:5566", "athlete_number.main:app"]

